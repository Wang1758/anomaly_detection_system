# 实施计划

## 智慧养殖场监控系统 - 任务清单

---

- [ ] 1. 项目初始化与基础架构搭建
  - 创建 Monorepo 根目录 `anomaly_detection_system`，包含 `backend`、`ai_service`、`frontend`、`proto`、`data` 五个子目录
  - 初始化各子项目的依赖管理文件（Go mod、Python requirements.txt、npm package.json）
  - 创建共享的 `.proto` 文件定义 gRPC 接口（图像输入、检测结果输出、参数更新接口）
  - 编写 Makefile 或脚本统一管理 proto 编译、服务启动等命令
  - _需求：4.1、4.5_

---

- [ ] 2. Python AI 微服务核心实现
  - [ ] 2.1 实现 gRPC 服务框架
    - 使用 `grpcio` 实现服务端，加载 proto 生成的代码
    - 实现 `Detect` 接口：接收图像字节数据，返回检测结果 JSON 列表
    - 使用 `concurrent.futures.ThreadPoolExecutor` 实现并发请求处理
    - _需求：1.1、1.5_

  - [ ] 2.2 实现 YOLOv11 推理与不确定性计算
    - 集成 `ultralytics` 库加载 YOLOv11 模型
    - 实现 NMS 处理逻辑，支持可配置的 IoU 阈值（默认 0.8）
    - 实现不确定性计算：基于混合加权公式 `Score = w1 * (1 - Conf) + w2 * IoU_With_Other_Boxes`
    - 返回结构包含 `bbox`、`class`、`conf`、`is_uncertain` 字段
    - _需求：1.1、1.2、1.3_

  - [ ] 2.3 实现模型热更新机制
    - 实现双缓冲模型加载：后台静默加载新权重，加载完成后原子切换指针
    - 实现 `ReloadModel` gRPC 接口，接收重载指令
    - 确保切换过程零停机
    - _需求：1.4_

  - [ ] 2.4 实现参数热更新接口
    - 实现 `UpdateParams` gRPC 接口
    - 支持动态更新：NMS IoU 阈值、置信度阈值、不确定性熵值阈值
    - _需求：1.6_

---

- [ ] 3. Go 业务后端核心实现
  - [ ] 3.1 实现视频采集管线（协程 A）
    - 使用 GoCV 实现视频源读取，支持 RTSP 流和本地视频文件
    - 实现帧率控制 Ticker（本地文件模式下强制 1/FPS 休眠）
    - 支持动态切换视频源和帧率（30/60 FPS）
    - _需求：2.1、2.2_

  - [ ] 3.2 实现 gRPC 通信管线（协程 B）
    - 实现 gRPC 客户端连接 Python AI 服务
    - 实现有序协程池批量发送请求，确保结果按序号排序返回
    - 实现流量控制和重试机制（最多 3 次）
    - _需求：2.3_

  - [ ] 3.3 实现 WebSocket 广播管线（协程 C）
    - 使用 `nhooyr.io/websocket` 实现 WebSocket 服务
    - 广播检测结果（JSON 坐标数据）和原始视频帧（Base64 编码）
    - 支持至少 10 个并发客户端连接
    - _需求：2.4_

  - [ ] 3.4 实现智能过滤机制（空间及时间抑制）
    - 维护 `ActiveAlerts` 列表，存储过去 60s 内的报警点
    - 实现 IoU 计算，过滤与已有报警重叠度 > 空间抑制阈值的新报警
    - 支持动态更新空间抑制 IoU 阈值（默认 0.5）
    - _需求：2.5_

  - [ ] 3.5 实现数据存储与数据库操作
    - 使用 GORM + SQLite 实现数据持久化
    - 定义 Sample 模型（ID、图片路径、时间、标注结果、是否已处理）
    - 实现样本保存接口：保存图片到 `data/images/`，元数据入库
    - _需求：2.6_

  - [ ] 3.6 实现配置热更新 RESTful API
    - 使用 Gin 实现 HTTP API
    - `POST /api/config/video` - 更新视频源配置
    - `POST /api/config/ai` - 转发 AI 参数更新到 Python 服务
    - `POST /api/config/filter` - 更新过滤参数
    - `POST /api/config/training` - 更新训练触发阈值
    - `POST /api/feedback` - 接收前端标注结果
    - _需求：2.8_

  - [ ] 3.7 实现闭环训练触发逻辑
    - 监控数据库中已标注样本数量
    - 当数量 >= 触发阈值时，调用 Shell 脚本启动 Python 训练
    - 训练完成后发送 `ReloadModel` 指令给 AI 服务
    - 支持手动触发训练 API
    - _需求：2.7、5.1、5.3_

---

- [ ] 4. 前端界面实现
  - [ ] 4.1 搭建 Vue 3 + TypeScript 项目框架
    - 使用 Vite 初始化项目
    - 配置 TailwindCSS，定义 Ethereal Glass 设计系统变量
    - 安装 Lucide Vue 图标库
    - 实现极光/网格渐变背景组件
    - _需求：3.1、4.4_

  - [ ] 4.2 实现悬浮布局与左侧导航 Dock
    - 实现悬浮岛布局框架（左导航、中央内容区、右侧边栏，各区域不贴边）
    - 实现 VisionOS 风格垂直 Dock 导航
    - 实现选中态/未选中态/悬停态样式切换
    - 实现 Monitor/Console 两个 Tab 切换逻辑
    - _需求：3.1.2、3.2_

  - [ ] 4.3 实现中央监控区 (MonitorView)
    - 实现视频源选择器组件（RTSP/本地视频切换，地址/路径输入）
    - 实现 16:9 视频容器，厚白边框画框效果
    - 实现 WebSocket 连接，接收视频帧和检测结果
    - 实现 Canvas 覆盖层绘制检测框（正常框蓝色、异常框橙色+模糊填充+胶囊标签）
    - 实现 LIVE 状态指示器
    - _需求：3.3_

  - [ ] 4.4 实现右侧报警队列 (AlertQueue)
    - 实现玻璃材质悬浮面板容器
    - 实现报警卡片组件（缩略图、时间戳、详情箭头，悬停上浮效果）
    - 实现 10 秒倒计时逻辑，超时自动收入待处理列表
    - 实现"异常/正常"选择交互，发送标注结果到后端
    - 实现 BBox 外扩 50% 截图逻辑
    - _需求：3.4_

  - [ ] 4.5 实现控制台 (ConsoleView)
    - 实现视频采集参数模块（视频源选择、地址输入、帧率选择 30/60 FPS）
    - 实现 AI 检测参数模块（iOS 风格滑块：置信度、熵值、NMS IoU 阈值）
    - 实现报警过滤参数模块（空间抑制 IoU 滑块）
    - 实现训练配置模块（触发阈值滑块、样本计数显示、训练按钮+进度状态）
    - 实现系统开关模块（iOS Toggle：报警推送、自动保存）
    - 实现参数更新 API 调用逻辑
    - _需求：3.5_

---

- [ ] 5. 闭环训练脚本实现
  - 编写 Python 增量训练脚本 `train.py`
  - 实现从 `data/` 目录读取新增标注数据
  - 实现基于旧权重的 Fine-tuning（冻结骨干网络，只微调 Head 层）
  - 训练完成后保存新权重到指定路径
  - 编写 Shell 脚本封装训练流程，支持被 Go 后端调用
  - _需求：5.2、5.3_

---

- [ ] 6. 系统集成与端到端测试
  - 编写 Docker Compose 配置，统一管理三个服务的启动
  - 验证完整数据流：视频采集 → AI 检测 → WebSocket 广播 → 前端渲染
  - 验证人机交互闭环：报警通知 → 用户标注 → 数据存储 → 训练触发 → 模型热更新
  - 验证所有可配置参数的热更新功能
  - 进行 24 小时稳定性测试
  - _需求：成功标准 1-6_

---

## 任务依赖关系

```
1 (项目初始化)
    ↓
2 (Python AI) ←──┐
    ↓            │
3 (Go 后端) ─────┤
    ↓            │
4 (前端) ────────┘
    ↓
5 (训练脚本)
    ↓
6 (集成测试)
```

## 预估工时

| 任务模块 | 预估工时 |
|---------|---------|
| 1. 项目初始化 | 0.5 天 |
| 2. Python AI 服务 | 2 天 |
| 3. Go 后端 | 3 天 |
| 4. 前端界面 | 3 天 |
| 5. 训练脚本 | 1 天 |
| 6. 集成测试 | 1.5 天 |
| **总计** | **11 天** |
